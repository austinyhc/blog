<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Learning Rate Finder | AUSTIN CAN HELP</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Learning Rate Finder" />
<meta name="author" content="Austin Chen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implementation of the LR Range test from Leslie Smith" />
<meta property="og:description" content="Implementation of the LR Range test from Leslie Smith" />
<link rel="canonical" href="https://austinyhc.github.io/blog/optimizer/learning%20rate/2020/12/30/implementation-of-learning-rate-finder.html" />
<meta property="og:url" content="https://austinyhc.github.io/blog/optimizer/learning%20rate/2020/12/30/implementation-of-learning-rate-finder.html" />
<meta property="og:site_name" content="AUSTIN CAN HELP" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-30T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://austinyhc.github.io/blog/optimizer/learning%20rate/2020/12/30/implementation-of-learning-rate-finder.html","@type":"BlogPosting","headline":"Learning Rate Finder","dateModified":"2020-12-30T00:00:00-06:00","datePublished":"2020-12-30T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://austinyhc.github.io/blog/optimizer/learning%20rate/2020/12/30/implementation-of-learning-rate-finder.html"},"author":{"@type":"Person","name":"Austin Chen"},"description":"Implementation of the LR Range test from Leslie Smith","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://austinyhc.github.io/blog/feed.xml" title="AUSTIN CAN HELP" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
<!-- Nees some of that sweet IBM Plex Mono -->
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">AUSTIN CAN HELP</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Learning Rate Finder</h1><p class="page-description">Implementation of the LR Range test from Leslie Smith</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-12-30T00:00:00-06:00" itemprop="datePublished">
        Dec 30, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Austin Chen</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#optimizer">optimizer</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#learning rate">learning rate</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/austinyhc/blog/tree/master/_notebooks/implementation-of-learning-rate-finder.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/austinyhc/blog/blob/master/_notebooks/implementation-of-learning-rate-finder.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Implement-LRFinder">Implement LRFinder </a></li>
<li class="toc-entry toc-h2"><a href="#Load-MNIST-dataset">Load MNIST dataset </a></li>
<li class="toc-entry toc-h2"><a href="#Pre-processing">Pre-processing </a></li>
<li class="toc-entry toc-h2"><a href="#Build-a-model">Build a model </a></li>
<li class="toc-entry toc-h2"><a href="#Train-without-finding-optimal-lr">Train without finding optimal lr </a></li>
<li class="toc-entry toc-h2"><a href="#Train-with-the-optimal-initial-lr">Train with the optimal initial lr </a></li>
<li class="toc-entry toc-h2"><a href="#Conclusion">Conclusion </a></li>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
<li class="toc-entry toc-h2"><a href="#1%-Better-Everyday">1% Better Everyday </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/implementation-of-learning-rate-finder.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Learning rate finder plots lr vs loss relationship for a Learner. The idea is to reduce the amount of guesswork on picking a good starting learning rate.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">albumentations</span> <span class="k">as</span> <span class="nn">A</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">Callback</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using TensorFlow v</span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using TensorFlow v2.4.0
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#@title Accelerator { run: "auto" }</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">'GPU'</span> <span class="c1">#@param ["None", "'GPU'", "'TPU'"] {type:"raw", allow-input: true}</span>

<span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"TPU"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"connecting to TPU..."</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">cluster_resolver</span><span class="o">.</span><span class="n">TPUClusterResolver</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Running on TPU '</span><span class="p">,</span> <span class="n">tpu</span><span class="o">.</span><span class="n">master</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Could not connect to TPU"</span><span class="p">)</span>
        <span class="n">tpu</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">tpu</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"initializing  TPU ..."</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental_connect_to_cluster</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">tpu</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">initialize_tpu_system</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">TPUStrategy</span><span class="p">(</span><span class="n">tpu</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"TPU initialized"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"failed to initialize TPU"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">"GPU"</span>

<span class="k">if</span> <span class="n">DEVICE</span> <span class="o">!=</span> <span class="s2">"TPU"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Using default strategy for CPU and single GPU"</span><span class="p">)</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">distribute</span><span class="o">.</span><span class="n">get_strategy</span><span class="p">()</span>

<span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"GPU"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Num GPUs Available: "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">'GPU'</span><span class="p">)))</span>
    

<span class="n">AUTOTUNE</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span>
<span class="n">REPLICAS</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'REPLICAS: </span><span class="si">{</span><span class="n">REPLICAS</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using default strategy for CPU and single GPU
Num GPUs Available:  1
REPLICAS: 1
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'PYTHONHASHSEED'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'TF_DETERMINISTIC_OPS'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'1'</span>

<span class="n">GOOGLE</span> <span class="o">=</span> <span class="s1">'google.colab'</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">())</span>
<span class="n">KAGGLE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">GOOGLE</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Running on </span><span class="si">{}</span><span class="s2">!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
   <span class="s2">"Google Colab"</span> <span class="k">if</span> <span class="n">GOOGLE</span> <span class="k">else</span> <span class="s2">"Kaggle Kernel"</span>
<span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Running on Google Colab!
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">SEED</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">seed_everything</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Implement-LRFinder">
<a class="anchor" href="#Implement-LRFinder" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implement <code>LRFinder</code><a class="anchor-link" href="#Implement-LRFinder"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LRFinder</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">"""Callback that exponentially adjusts the learning rate after each</span>
<span class="sd">    training batch between start_lr and end_lr for a maximum number of </span>
<span class="sd">    batches: max_step. The loss and learning rate are recorded at each</span>
<span class="sd">    step allowing visually finding a good learning rate as per </span>
<span class="sd">    https://sgugger.github.io/how-do-you-find-a-good-learning-rate.html</span>
<span class="sd">    via the plot method.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span> <span class="n">end_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LRFinder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_lr</span> <span class="o">=</span> <span class="n">start_lr</span><span class="p">,</span> <span class="n">end_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">max_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_annealing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">logs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'loss'</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="k">if</span> <span class="n">loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_loss</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
            <span class="n">smooth_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_loss</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smooth_loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">loss</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="o">=</span> <span class="n">loss</span>

            <span class="k">if</span> <span class="n">smooth_loss</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_loss</span> <span class="ow">or</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_nan</span><span class="p">(</span><span class="n">smooth_loss</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stop_training</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">exp_annealing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_lr</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_lr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_lr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">"#F0F0F0"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Learning Rate'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">'</span><span class="si">%.0e</span><span class="s1">'</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-MNIST-dataset">
<a class="anchor" href="#Load-MNIST-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Load MNIST dataset<a class="anchor-link" href="#Load-MNIST-dataset"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(60000, 28, 28) (10000, 28, 28) (60000,) (10000,)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pre-processing">
<a class="anchor" href="#Pre-processing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pre-processing<a class="anchor-link" href="#Pre-processing"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'x_train shape:'</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'x_test shape:'</span><span class="p">,</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>x_train shape: (60000, 28, 28, 1)
x_test shape: (10000, 28, 28, 1)
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'y_train shape:'</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'y_test shape:'</span><span class="p">,</span> <span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>y_train shape: (60000, 10)
y_test shape: (10000, 10)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Build-a-model">
<a class="anchor" href="#Build-a-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build a model<a class="anchor-link" href="#Build-a-model"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_simple_model</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">,</span>
                                     <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'softmax'</span><span class="p">))</span>
    
    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr</span> <span class="k">if</span> <span class="n">lr</span> <span class="k">else</span> <span class="mf">1e-3</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'categorical_crossentropy'</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">STEPS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">BATCH_SIZE</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Train-without-finding-optimal-lr">
<a class="anchor" href="#Train-without-finding-optimal-lr" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train without finding optimal lr<a class="anchor-link" href="#Train-without-finding-optimal-lr"> </a>
</h2>
<p>Let us train our model without searching for an optimal learning rate. We will be using the default learning rate for the optimizer</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">build_simple_model</span><span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 1/6
1875/1875 [==============================] - 7s 4ms/step - loss: 0.3609 - accuracy: 0.8875
Epoch 2/6
1875/1875 [==============================] - 7s 4ms/step - loss: 0.0859 - accuracy: 0.9743
Epoch 3/6
1875/1875 [==============================] - 7s 3ms/step - loss: 0.0551 - accuracy: 0.9825
Epoch 4/6
1875/1875 [==============================] - 6s 3ms/step - loss: 0.0504 - accuracy: 0.9844
Epoch 5/6
1875/1875 [==============================] - 6s 3ms/step - loss: 0.0398 - accuracy: 0.9878
Epoch 6/6
1875/1875 [==============================] - 6s 3ms/step - loss: 0.0354 - accuracy: 0.9885
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;tensorflow.python.keras.callbacks.History at 0x7f01f217d978&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Test loss:'</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Test accuracy:'</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Test loss: 0.03285309299826622
Test accuracy: 0.9901000261306763
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Train-with-the-optimal-initial-lr">
<a class="anchor" href="#Train-with-the-optimal-initial-lr" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train with the optimal initial lr<a class="anchor-link" href="#Train-with-the-optimal-initial-lr"> </a>
</h2>
<p>We will create an instance of the class we built above and pass it as a callback to our model. The LR finder is very cheap in terms of compute and it hardly takes an epoch or less to complete. We will keep the default values of <code>base_lr</code> and <code>max_lr</code> but you can change it if you want to.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr_finder</span> <span class="o">=</span> <span class="n">LRFinder</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">model2</span> <span class="o">=</span> <span class="n">build_simple_model</span><span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> 
               <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lr_finder</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>WARNING:tensorflow:Callback method `on_train_batch_end` is slow compared to the batch time (batch time: 0.0021s vs `on_train_batch_end` time: 0.0033s). Check your callbacks.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lr_finder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's train the model with the optimal lr found using LR finder</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model3</span> <span class="o">=</span> <span class="n">build_simple_model</span><span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">3e-3</span><span class="p">)</span>
<span class="n">model3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 1/6
1875/1875 [==============================] - 7s 4ms/step - loss: 0.2942 - accuracy: 0.9101
Epoch 2/6
1875/1875 [==============================] - 6s 3ms/step - loss: 0.0943 - accuracy: 0.9716
Epoch 3/6
1875/1875 [==============================] - 6s 3ms/step - loss: 0.0697 - accuracy: 0.9793
Epoch 4/6
1875/1875 [==============================] - 7s 3ms/step - loss: 0.0616 - accuracy: 0.9808
Epoch 5/6
1875/1875 [==============================] - 7s 3ms/step - loss: 0.0510 - accuracy: 0.9843
Epoch 6/6
1875/1875 [==============================] - 7s 3ms/step - loss: 0.0519 - accuracy: 0.9849
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;tensorflow.python.keras.callbacks.History at 0x7f01f212f908&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">score</span> <span class="o">=</span> <span class="n">model3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Test loss:'</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Test accuracy:'</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Test loss: 0.029018929228186607
Test accuracy: 0.9915000200271606
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can see that if we start with an optimal learning rate, we can coverge much faster. A good start always pays off!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h2>
<p>In this notebook, we saw how we can implement a simple <code>LR finder</code> in keras. Keras gives you the hooks to implement almost anything seamlessly. Before writing anything from scratch, you should always check how can you use a hook to implement it in Keras first.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<ul>
<li><a href="https://arxiv.org/abs/1708.07120">https://arxiv.org/abs/1708.07120</a></li>
<li><a href="https://arxiv.org/abs/1506.01186">https://arxiv.org/abs/1506.01186</a></li>
<li><a href="https://arxiv.org/abs/1803.09820">https://arxiv.org/abs/1803.09820</a></li>
<li><a href="https://sgugger.github.io/how-do-you-find-a-good-learning-rate.html">https://sgugger.github.io/how-do-you-find-a-good-learning-rate.html</a></li>
</ul>
<h2 id="1%-Better-Everyday">
<a class="anchor" href="#1%-Better-Everyday" aria-hidden="true"><span class="octicon octicon-link"></span></a>1% Better Everyday<a class="anchor-link" href="#1%-Better-Everyday"> </a>
</h2>
<p>Maybe we don't really need to create a class for learning rate finder. Perhaps we can achieve the same goal by using the <code>tf.keras.optimizers.schedules.ExponentialDecay</code> plus tensor board.</p>
<ul>
<li><a href="https://blog.dataiku.com/the-learning-rate-finder-technique-how-reliable-is-it">https://blog.dataiku.com/the-learning-rate-finder-technique-how-reliable-is-it</a></li>
<li><a href="https://medium.com/octavian-ai/how-to-use-the-learning-rate-finder-in-tensorflow-126210de9489">https://medium.com/octavian-ai/how-to-use-the-learning-rate-finder-in-tensorflow-126210de9489</a></li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/blog/optimizer/learning%20rate/2020/12/30/implementation-of-learning-rate-finder.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Thoughts when I am building</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/austinyhc" title="austinyhc"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/austinyht" title="austinyht"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
