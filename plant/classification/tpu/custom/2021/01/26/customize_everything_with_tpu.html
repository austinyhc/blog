<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Custom Everything with TPU | AUSTIN CAN HELP</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Custom Everything with TPU" />
<meta name="author" content="Austin Chen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Getting start to customize everything with TPU" />
<meta property="og:description" content="Getting start to customize everything with TPU" />
<link rel="canonical" href="https://austinyhc.github.io/blog/plant/classification/tpu/custom/2021/01/26/customize_everything_with_tpu.html" />
<meta property="og:url" content="https://austinyhc.github.io/blog/plant/classification/tpu/custom/2021/01/26/customize_everything_with_tpu.html" />
<meta property="og:site_name" content="AUSTIN CAN HELP" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-26T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://austinyhc.github.io/blog/plant/classification/tpu/custom/2021/01/26/customize_everything_with_tpu.html","@type":"BlogPosting","headline":"Custom Everything with TPU","dateModified":"2021-01-26T00:00:00-06:00","datePublished":"2021-01-26T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://austinyhc.github.io/blog/plant/classification/tpu/custom/2021/01/26/customize_everything_with_tpu.html"},"author":{"@type":"Person","name":"Austin Chen"},"description":"Getting start to customize everything with TPU","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://austinyhc.github.io/blog/feed.xml" title="AUSTIN CAN HELP" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">AUSTIN CAN HELP</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Custom Everything with TPU</h1><p class="page-description">Getting start to customize everything with TPU</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-01-26T00:00:00-06:00" itemprop="datePublished">
        Jan 26, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Austin Chen</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      12 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#plant">plant</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#classification">classification</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#tpu">tpu</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#custom">custom</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/austinyhc/blog/tree/master/_notebooks/customize_everything_with_tpu.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/austinyhc/blog/blob/master/_notebooks/customize_everything_with_tpu.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#1%-Better-Everyday">1% Better Everyday </a></li>
<li class="toc-entry toc-h1"><a href="#Hyperparameters">Hyperparameters </a></li>
<li class="toc-entry toc-h1"><a href="#Data">Data </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Loading-data">Loading data </a></li>
<li class="toc-entry toc-h2"><a href="#Data-augmentation">Data augmentation </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Custom-Model">Custom Model </a></li>
<li class="toc-entry toc-h1"><a href="#Custom-Optimizer-Schedule">Custom Optimizer Schedule </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Custom-Loss-Function">Custom Loss Function </a></li>
<li class="toc-entry toc-h2"><a href="#Custom-Metric-Function">Custom Metric Function </a></li>
<li class="toc-entry toc-h2"><a href="#Custom-Training-Loop">Custom Training Loop </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/customize_everything_with_tpu.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="1%-Better-Everyday">
<a class="anchor" href="#1%-Better-Everyday" aria-hidden="true"><span class="octicon octicon-link"></span></a>1% Better Everyday<a class="anchor-link" href="#1%-Better-Everyday"> </a>
</h1>
<ul>
<li>Add momentum to the custom optimizer</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">albumentations</span> <span class="k">as</span> <span class="nn">A</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">import</span> <span class="nn">tensorflow_hub</span> <span class="k">as</span> <span class="nn">hub</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span> <span class="nn">fastprogress.fastprogress</span> <span class="kn">import</span> <span class="n">master_bar</span><span class="p">,</span> <span class="n">progress_bar</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using TensorFlow v</span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using TensorFlow v2.4.0
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-success">
    <svg class="octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist octicon octicon-checklist" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M2.5 1.75a.25.25 0 01.25-.25h8.5a.25.25 0 01.25.25v7.736a.75.75 0 101.5 0V1.75A1.75 1.75 0 0011.25 0h-8.5A1.75 1.75 0 001 1.75v11.5c0 .966.784 1.75 1.75 1.75h3.17a.75.75 0 000-1.5H2.75a.25.25 0 01-.25-.25V1.75zM4.75 4a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5zM4 7.75A.75.75 0 014.75 7h2a.75.75 0 010 1.5h-2A.75.75 0 014 7.75zm11.774 3.537a.75.75 0 00-1.048-1.074L10.7 14.145 9.281 12.72a.75.75 0 00-1.062 1.058l1.943 1.95a.75.75 0 001.055.008l4.557-4.45z"></path></svg>
    <strong>Tip: </strong>Adding seed helps reproduce results. Setting debug parameter wil run the model on smaller number of epochs to validate the architecture.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'PYTHONHASHSEED'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'TF_DETERMINISTIC_OPS'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'1'</span>

<span class="n">GOOGLE</span> <span class="o">=</span> <span class="s1">'google.colab'</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">())</span>
<span class="n">KAGGLE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">GOOGLE</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Running on </span><span class="si">{}</span><span class="s2">!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
   <span class="s2">"Google Colab"</span> <span class="k">if</span> <span class="n">GOOGLE</span> <span class="k">else</span> <span class="s2">"Kaggle Kernel"</span>
<span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Hyperparameters">
<a class="anchor" href="#Hyperparameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hyperparameters<a class="anchor-link" href="#Hyperparameters"> </a>
</h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span><span class="c1">#@param {type:"number"}</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span><span class="c1">#@param {type:"number"}</span>
<span class="n">CHANNELS</span> <span class="o">=</span> <span class="mi">3</span><span class="c1">#@param {type:"number"}</span>
<span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">CHANNELS</span><span class="p">)</span>
<span class="n">EPOCHS</span> <span class="o">=</span>  <span class="mi">50</span><span class="c1">#@param {type:"number"}</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span> <span class="c1">#@param {type:"raw"}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Input size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Train on batch size of </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2"> epochs"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data">
<a class="anchor" href="#Data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data<a class="anchor-link" href="#Data"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading-data">
<a class="anchor" href="#Loading-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Loading data<a class="anchor-link" href="#Loading-data"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">run_if</span> {GOOGLE}
#@title {run: "auto", display-mode: "form"}
# reference: https://www.kaggle.com/austinyhc/custom-training-with-tpu?scriptVersionId=51687595
GCS_DS_PATH = 'gs://kds-7396cd0f7b0e4a357b814bc6e35f76021f3a9f220e13e7b2d3c3fb39' #@param {type: "string"}
GCS_PATH_SELECT = {
    192: GCS_DS_PATH + '/tfrecords-jpeg-192x192',
    224: GCS_DS_PATH + '/tfrecords-jpeg-224x224',
    331: GCS_DS_PATH + '/tfrecords-jpeg-331x331',
    512: GCS_DS_PATH + '/tfrecords-jpeg-512x512'
}
print(f"Sourcing images from")
for v in GCS_PATH_SELECT.values(): print(f"\t{v}")
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'pink primrose'</span><span class="p">,</span>        <span class="s1">'hard-leaved pocket orchid'</span><span class="p">,</span> <span class="s1">'canterbury bells'</span><span class="p">,</span> <span class="s1">'sweet pea'</span><span class="p">,</span>     <span class="s1">'wild geranium'</span><span class="p">,</span>
           <span class="s1">'tiger lily'</span><span class="p">,</span>           <span class="s1">'moon orchid'</span><span class="p">,</span>               <span class="s1">'bird of paradise'</span><span class="p">,</span> <span class="s1">'monkshood'</span><span class="p">,</span>     <span class="s1">'globe thistle'</span><span class="p">,</span>        
           <span class="s1">'snapdragon'</span><span class="p">,</span>           <span class="s2">"colt's foot"</span><span class="p">,</span>               <span class="s1">'king protea'</span><span class="p">,</span>      <span class="s1">'spear thistle'</span><span class="p">,</span> <span class="s1">'yellow iris'</span><span class="p">,</span>
           <span class="s1">'globe-flower'</span><span class="p">,</span>         <span class="s1">'purple coneflower'</span><span class="p">,</span>         <span class="s1">'peruvian lily'</span><span class="p">,</span>    <span class="s1">'balloon flower'</span><span class="p">,</span><span class="s1">'giant white arum lily'</span><span class="p">,</span>
           <span class="s1">'fire lily'</span><span class="p">,</span>            <span class="s1">'pincushion flower'</span><span class="p">,</span>         <span class="s1">'fritillary'</span><span class="p">,</span>       <span class="s1">'red ginger'</span><span class="p">,</span>    <span class="s1">'grape hyacinth'</span><span class="p">,</span>
           <span class="s1">'corn poppy'</span><span class="p">,</span>           <span class="s1">'prince of wales feathers'</span><span class="p">,</span>  <span class="s1">'stemless gentian'</span><span class="p">,</span> <span class="s1">'artichoke'</span><span class="p">,</span>     <span class="s1">'sweet william'</span><span class="p">,</span>        
           <span class="s1">'carnation'</span><span class="p">,</span>            <span class="s1">'garden phlox'</span><span class="p">,</span>              <span class="s1">'love in the mist'</span><span class="p">,</span> <span class="s1">'cosmos'</span><span class="p">,</span>        <span class="s1">'alpine sea holly'</span><span class="p">,</span>
           <span class="s1">'ruby-lipped cattleya'</span><span class="p">,</span> <span class="s1">'cape flower'</span><span class="p">,</span>               <span class="s1">'great masterwort'</span><span class="p">,</span> <span class="s1">'siam tulip'</span><span class="p">,</span>    <span class="s1">'lenten rose'</span><span class="p">,</span>          
           <span class="s1">'barberton daisy'</span><span class="p">,</span>      <span class="s1">'daffodil'</span><span class="p">,</span>                  <span class="s1">'sword lily'</span><span class="p">,</span>       <span class="s1">'poinsettia'</span><span class="p">,</span>    <span class="s1">'bolero deep blue'</span><span class="p">,</span>
           <span class="s1">'wallflower'</span><span class="p">,</span>           <span class="s1">'marigold'</span><span class="p">,</span>                  <span class="s1">'buttercup'</span><span class="p">,</span>        <span class="s1">'daisy'</span><span class="p">,</span>         <span class="s1">'common dandelion'</span><span class="p">,</span>     
           <span class="s1">'petunia'</span><span class="p">,</span>              <span class="s1">'wild pansy'</span><span class="p">,</span>                <span class="s1">'primula'</span><span class="p">,</span>          <span class="s1">'sunflower'</span><span class="p">,</span>     <span class="s1">'lilac hibiscus'</span><span class="p">,</span>
           <span class="s1">'bishop of llandaff'</span><span class="p">,</span>   <span class="s1">'gaura'</span><span class="p">,</span>                     <span class="s1">'geranium'</span><span class="p">,</span>         <span class="s1">'orange dahlia'</span><span class="p">,</span> <span class="s1">'pink-yellow dahlia'</span><span class="p">,</span>   
           <span class="s1">'cautleya spicata'</span><span class="p">,</span>     <span class="s1">'japanese anemone'</span><span class="p">,</span>          <span class="s1">'black-eyed susan'</span><span class="p">,</span> <span class="s1">'silverbush'</span><span class="p">,</span>    <span class="s1">'californian poppy'</span><span class="p">,</span>
           <span class="s1">'osteospermum'</span><span class="p">,</span>         <span class="s1">'spring crocus'</span><span class="p">,</span>             <span class="s1">'iris'</span><span class="p">,</span>             <span class="s1">'windflower'</span><span class="p">,</span>    <span class="s1">'tree poppy'</span><span class="p">,</span>           
           <span class="s1">'gazania'</span><span class="p">,</span>              <span class="s1">'azalea'</span><span class="p">,</span>                    <span class="s1">'water lily'</span><span class="p">,</span>       <span class="s1">'rose'</span><span class="p">,</span>          <span class="s1">'thorn apple'</span><span class="p">,</span>
           <span class="s1">'morning glory'</span><span class="p">,</span>        <span class="s1">'passion flower'</span><span class="p">,</span>            <span class="s1">'lotus'</span><span class="p">,</span>            <span class="s1">'toad lily'</span><span class="p">,</span>     <span class="s1">'anthurium'</span><span class="p">,</span>
           <span class="s1">'frangipani'</span><span class="p">,</span>           <span class="s1">'clematis'</span><span class="p">,</span>                  <span class="s1">'hibiscus'</span><span class="p">,</span>         <span class="s1">'columbine'</span><span class="p">,</span>     <span class="s1">'desert-rose'</span><span class="p">,</span>
           <span class="s1">'tree mallow'</span><span class="p">,</span>          <span class="s1">'magnolia'</span><span class="p">,</span>                  <span class="s1">'cyclamen '</span><span class="p">,</span>        <span class="s1">'watercress'</span><span class="p">,</span>    <span class="s1">'canna lily'</span><span class="p">,</span>           
           <span class="s1">'hippeastrum '</span><span class="p">,</span>         <span class="s1">'bee balm'</span><span class="p">,</span>                  <span class="s1">'pink quill'</span><span class="p">,</span>       <span class="s1">'foxglove'</span><span class="p">,</span>      <span class="s1">'bougainvillea'</span><span class="p">,</span>
           <span class="s1">'camellia'</span><span class="p">,</span>             <span class="s1">'mallow'</span><span class="p">,</span>                    <span class="s1">'mexican petunia'</span><span class="p">,</span>  <span class="s1">'bromelia'</span><span class="p">,</span>      <span class="s1">'blanket flower'</span><span class="p">,</span>       
           <span class="s1">'trumpet creeper'</span><span class="p">,</span>      <span class="s1">'blackberry lily'</span><span class="p">,</span>           <span class="s1">'common tulip'</span><span class="p">,</span>     <span class="s1">'wild rose'</span><span class="p">]</span>

<span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">NCLASSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CLASSES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of labels: </span><span class="si">{</span><span class="n">NCLASSES</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">count_data_items</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"-([0-9]*)\."</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">inspect_tfrecord</span><span class="p">(</span><span class="n">tfrec</span><span class="p">):</span>
    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfrec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">raw_record</span> <span class="ow">in</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">()</span>
        <span class="n">example</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">raw_record</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_filenames</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">GCS_PATH_SELECT</span><span class="p">[</span><span class="n">HEIGHT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/train/*.tfrec'</span><span class="p">)</span>
<span class="n">valid_filenames</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">GCS_PATH_SELECT</span><span class="p">[</span><span class="n">HEIGHT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/val/*.tfrec'</span><span class="p">)</span>
<span class="n">test_filenames</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">GCS_PATH_SELECT</span><span class="p">[</span><span class="n">HEIGHT</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/test/*.tfrec'</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inspect_tfrecord</span><span class="p">(</span><span class="n">train_filenames</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">decode_image</span><span class="p">(</span><span class="n">image_string</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">read_tfrecord</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">TFREC_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"image"</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s2">"class"</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="s2">"id"</span>    <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">}</span> <span class="k">if</span> <span class="n">labeled</span> <span class="k">else</span> <span class="p">{</span>
        <span class="s2">"image"</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s2">"id"</span>    <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">TFREC_FORMAT</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">decode_image</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">'image'</span><span class="p">])</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s1">'class'</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">if</span> <span class="n">labeled</span> <span class="k">else</span> <span class="n">example</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-augmentation">
<a class="anchor" href="#Data-augmentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data augmentation<a class="anchor-link" href="#Data-augmentation"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">transform_shear</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">shear</span><span class="p">):</span>
    <span class="c1"># input image - is one image of size [dim,dim,3] not a batch of [b,dim,dim,3]</span>
    <span class="c1"># output - image randomly sheared</span>
    <span class="n">DIM</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">XDIM</span> <span class="o">=</span> <span class="n">DIM</span><span class="o">%</span><span class="k">2</span> #fix for size 331
    
    <span class="n">shear</span> <span class="o">=</span> <span class="n">shear</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">shear</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">shear</span> <span class="o">/</span> <span class="mf">180.</span>
        
    <span class="c1"># SHEAR MATRIX</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">shear</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">shear</span><span class="p">)</span>
    <span class="n">shear_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">one</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>    

    <span class="c1"># LIST DESTINATION PIXEL INDICES</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">DIM</span> <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">),[</span><span class="n">DIM</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1"># ROTATE DESTINATION PIXELS ONTO ORIGIN PIXELS</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shear_matrix</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">))</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">XDIM</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># FIND ORIGIN PIXEL VALUES </span>
    <span class="n">idx3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">idx2</span><span class="p">[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="mi">1</span><span class="p">,]]</span> <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">idx3</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="p">,[</span><span class="n">DIM</span><span class="p">,</span><span class="n">DIM</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">transform_shift</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">h_shift</span><span class="p">,</span> <span class="n">w_shift</span><span class="p">):</span>
    <span class="c1"># input image - is one image of size [dim,dim,3] not a batch of [b,dim,dim,3]</span>
    <span class="c1"># output - image randomly shifted</span>
    <span class="n">DIM</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">XDIM</span> <span class="o">=</span> <span class="n">DIM</span><span class="o">%</span><span class="k">2</span> #fix for size 331
    
    <span class="n">height_shift</span> <span class="o">=</span> <span class="n">h_shift</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span> 
    <span class="n">width_shift</span> <span class="o">=</span> <span class="n">w_shift</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span> 
    <span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
        
    <span class="c1"># SHIFT MATRIX</span>
    <span class="n">shift_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">one</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">height_shift</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span><span class="n">one</span><span class="p">,</span><span class="n">width_shift</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">one</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># LIST DESTINATION PIXEL INDICES</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">DIM</span> <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">),[</span><span class="n">DIM</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1"># ROTATE DESTINATION PIXELS ONTO ORIGIN PIXELS</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shift_matrix</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">))</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">XDIM</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># FIND ORIGIN PIXEL VALUES </span>
    <span class="n">idx3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">idx2</span><span class="p">[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="mi">1</span><span class="p">,]]</span> <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">idx3</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="p">,[</span><span class="n">DIM</span><span class="p">,</span><span class="n">DIM</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">transform_rotation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">rotation</span><span class="p">):</span>
    <span class="c1"># input image - is one image of size [dim,dim,3] not a batch of [b,dim,dim,3]</span>
    <span class="c1"># output - image randomly rotated</span>
    <span class="n">DIM</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">XDIM</span> <span class="o">=</span> <span class="n">DIM</span><span class="o">%</span><span class="k">2</span> #fix for size 331
    
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="c1"># CONVERT DEGREES TO RADIANS</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rotation</span> <span class="o">/</span> <span class="mf">180.</span>
    
    <span class="c1"># ROTATION MATRIX</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">c1</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span> <span class="o">-</span><span class="n">s1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span><span class="n">zero</span><span class="p">,</span><span class="n">one</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># LIST DESTINATION PIXEL INDICES</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">DIM</span> <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">),[</span><span class="n">DIM</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1"># ROTATE DESTINATION PIXELS ONTO ORIGIN PIXELS</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">))</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">)</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx2</span><span class="p">,</span><span class="o">-</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">XDIM</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># FIND ORIGIN PIXEL VALUES </span>
    <span class="n">idx3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span> <span class="p">[</span><span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">idx2</span><span class="p">[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">DIM</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">idx2</span><span class="p">[</span><span class="mi">1</span><span class="p">,]]</span> <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">idx3</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="p">,[</span><span class="n">DIM</span><span class="p">,</span><span class="n">DIM</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description" open="">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">data_augment</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">p_rotation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">p_spatial</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">p_rotate</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">p_pixel</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>    
    <span class="n">p_shear</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">p_shift</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">p_crop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Flips</span>
    <span class="k">if</span> <span class="n">p_spatial</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_flip_left_right</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_flip_up_down</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        
    <span class="c1"># Rotates</span>
    <span class="k">if</span> <span class="n">p_rotate</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">75</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># rotate 270º</span>
    <span class="k">elif</span> <span class="n">p_rotate</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># rotate 180º</span>
    <span class="k">elif</span> <span class="n">p_rotate</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">25</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># rotate 90º</span>
    
    <span class="k">if</span> <span class="n">p_rotation</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># Rotation</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform_rotation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mf">45.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_shift</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># Shift</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform_shift</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">h_shift</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span> <span class="n">w_shift</span><span class="o">=</span><span class="mf">15.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_shear</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># Shear</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform_shear</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">shear</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
        
    <span class="c1"># Crops</span>
    <span class="k">if</span> <span class="n">p_crop</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">crop_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span> <span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="o">*.</span><span class="mi">7</span><span class="p">),</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">,</span> <span class="n">CHANNELS</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">p_crop</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">7</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p_crop</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">central_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">central_fraction</span><span class="o">=.</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_crop</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">8</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">central_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">central_fraction</span><span class="o">=.</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">central_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">central_fraction</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
            
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">])</span>
        
    <span class="c1"># Pixel-level transforms</span>
    <span class="k">if</span> <span class="n">p_pixel</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p_pixel</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">8</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_saturation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_pixel</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">6</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_contrast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">lower</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p_pixel</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_brightness</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_delta</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">adjust_gamma</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ignore_order</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span><span class="p">:</span> <span class="n">ignore_order</span><span class="o">.</span><span class="n">experimental_deterministic</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">num_parallel_reads</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">ignore_order</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">read_tfrecord</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="n">labeled</span><span class="p">),</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>

<span class="k">def</span> <span class="nf">get_train_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">data_augment</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
    <span class="c1"># prefetch the next batch while training</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
 
<span class="k">def</span> <span class="nf">get_valid_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
    <span class="c1"># prefetch the next batch while training</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>

<span class="k">def</span> <span class="nf">get_test_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    <span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">labeled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="n">ordered</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
    <span class="c1"># prefetch the next batch while training</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">get_train_dataset</span><span class="p">(</span><span class="n">train_filenames</span><span class="p">)</span>
<span class="n">valid_ds</span> <span class="o">=</span> <span class="n">get_valid_dataset</span><span class="p">(</span><span class="n">valid_filenames</span><span class="p">)</span>
<span class="n">test_ds</span>  <span class="o">=</span> <span class="n">get_test_dataset</span><span class="p">(</span><span class="n">test_filenames</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">CLASSES</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Custom-Model">
<a class="anchor" href="#Custom-Model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Model<a class="anchor-link" href="#Custom-Model"> </a>
</h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">Xception</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">DenseNet121</span><span class="p">,</span> <span class="n">DenseNet169</span><span class="p">,</span> <span class="n">DenseNet201</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">ResNet50V2</span><span class="p">,</span> <span class="n">ResNet101V2</span><span class="p">,</span> <span class="n">ResNet152V2</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">InceptionV3</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">InceptionResNetV2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Flower_Classifier</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Xception</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s1">'imagenet'</span><span class="p">,</span>
                     <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">input_shape</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ResNet152V2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s1">'imagenet'</span><span class="p">,</span>
                        <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">InceptionResNetV2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s1">'imagenet'</span><span class="p">,</span>
                              <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">input_shape</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pooling_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layer_normalization_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_dist_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_idx</span><span class="p">,</span> <span class="n">image_embedded_layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer_normalization_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1E-6</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prob_dist_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">NCLASSES</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'softmax'</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'prob_dist_</span><span class="si">{</span><span class="n">model_idx</span><span class="si">}</span><span class="s1">'</span><span class="p">))</span>

        <span class="n">kernel_init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.86690587</span><span class="p">,</span> <span class="mf">1.0948032</span><span class="p">,</span> <span class="mf">1.1121726</span><span class="p">]))</span> 
        <span class="n">bias_init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.13309559</span><span class="p">,</span> <span class="mf">0.09480964</span><span class="p">,</span> <span class="mf">0.11218266</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prob_dist_weight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"softmax"</span><span class="p">,</span>
            <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">kernel_init</span><span class="p">,</span>
            <span class="n">bias_initializer</span><span class="o">=</span><span class="n">bias_init</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">'prob_dist_weight'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">all_model_outputs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="p">)):</span>
            <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_embedding_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
            <span class="n">pooling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling_layer</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
            <span class="n">pooling_normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_normalization_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">pooling</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
            <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_dist_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">pooling_normalized</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
            <span class="n">all_model_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_output</span><span class="p">)</span>

        <span class="n">all_model_outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">all_model_outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_dist_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_dist_weight</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="n">prob_dist</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">prob_dist_weight</span><span class="p">,</span> <span class="n">all_model_outputs</span><span class="p">)</span>
        <span class="n">prob_dist</span> <span class="o">=</span> <span class="n">prob_dist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">prob_dist</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span> <span class="n">flower_classifier</span> <span class="o">=</span> <span class="n">Flower_Classifier</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>There is a workaround to show <code>summary()</code> of a subclassing model which is introduced in <a href="https://youtu.be/WcZ_1IAH_nM?list=PLhhyoLH6IjfxVOdVC1P1L5z5azs0XjMsb&amp;t=1124">this video</a>.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flower_classifier</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Custom-Optimizer-Schedule">
<a class="anchor" href="#Custom-Optimizer-Schedule" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Optimizer Schedule<a class="anchor-link" href="#Custom-Optimizer-Schedule"> </a>
</h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CustomCyclicSchedule</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">CosineDecay</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_step</span><span class="p">,</span> <span class="n">lr_max</span><span class="p">,</span> <span class="n">div</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">div_final</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span>
                 <span class="n">pct_start</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">staircase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_start</span> <span class="o">=</span> <span class="n">lr_max</span> <span class="o">/</span> <span class="n">div</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span> <span class="o">=</span> <span class="n">lr_max</span> <span class="o">/</span> <span class="n">div_final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rising_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_step</span> <span class="o">*</span> <span class="n">pct_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rising_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_max</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rising_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rising_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">falling_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_step</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rising_steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">falling_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span> <span class="o">/</span> <span class="n">lr_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">initial_learning_rate</span> <span class="o">=</span> <span class="n">lr_max</span><span class="p">,</span>
            <span class="n">decay_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">falling_steps</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">""" `step` is actually the step index, starting at 0. """</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rising_a</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rising_b</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rising_steps</span> <span class="k">else</span>
              <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">step</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rising_steps</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">NSTEPS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">count_data_items</span><span class="p">(</span><span class="n">train_filenames</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="n">EPOCHS</span>
    <span class="n">LR_MAX</span> <span class="o">=</span> <span class="mf">1e-4</span> <span class="c1">#@param {type: "number"}</span>
    <span class="n">LR_MAX</span> <span class="o">*=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">num_replicas_in_sync</span>
    <span class="n">DIV</span> <span class="o">=</span> <span class="mf">25.0</span> <span class="c1">#@param {type: "number"}</span>
    <span class="n">DIV_FINAL</span> <span class="o">=</span> <span class="mf">1e5</span> <span class="c1">#@param {type: "number"}</span>
    <span class="n">PCT_START</span> <span class="o">=</span> <span class="mf">0.25</span><span class="c1">#@param {type: "number"}</span>
    
    <span class="n">schedule</span> <span class="o">=</span> <span class="n">CustomCyclicSchedule</span><span class="p">(</span>
        <span class="n">n_step</span><span class="o">=</span><span class="n">NSTEPS</span><span class="p">,</span>
        <span class="n">lr_max</span><span class="o">=</span><span class="n">LR_MAX</span><span class="p">,</span>
        <span class="n">div</span><span class="o">=</span><span class="n">DIV</span><span class="p">,</span>
        <span class="n">div_final</span><span class="o">=</span><span class="n">DIV_FINAL</span><span class="p">,</span>
        <span class="n">cycle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">xps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">NSTEPS</span><span class="p">)</span>
<span class="n">yps</span> <span class="o">=</span> <span class="p">[</span><span class="n">schedule</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xps</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">'#F0F0F0'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xps</span><span class="p">,</span> <span class="n">yps</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">'#F8F8F8'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'iteration'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'learning rate'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">{:d}</span><span class="s1"> total epochs and </span><span class="si">{:d}</span><span class="s1"> steps per epoch'</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">NSTEPS</span> <span class="o">//</span> <span class="n">EPOCHS</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">schedule</span><span class="o">.</span><span class="n">get_config</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-Loss-Function">
<a class="anchor" href="#Custom-Loss-Function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Loss Function<a class="anchor-link" href="#Custom-Loss-Function"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>About why we set <code>reduction</code> to <code>&amp;#8217;none&amp;#8217;</code>, please check this <a href="https://www.tensorflow.org/tutorials/distribute/custom_training#define_the_loss_function">tutorial</a>. In particular, read the paragraph. If using <code>tf.keras.losses</code> classes (as in the example below), the loss reduction needs to be explicitly specified to be one of <code>NONE</code> or <code>SUM</code>. <code>AUTO</code> and <code>SUM_OVER_BATCH_SIZE</code> are disallowed when used with <code>tf.distribute.Strategy</code>.
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>About why we use <code>tf.nn.compute_average_loss</code>, please check this <a href="https://www.tensorflow.org/tutorials/distribute/custom_training#define_the_loss_function">tutorial</a>
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="flash flash-error">
    <svg class="octicon octicon-alert octicon octicon-alert" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path></svg>
    <strong>Warning: </strong>While trained with <code>BATCH_SIZE = 8 * strategy.num_replicas_in_sync</code>, I got <code>nan</code> values. Since we pass probability distribution to <code>CategoricalCrossentropy</code> with <code>from_logits = False</code>, which has numerical unstability issue, we use the same trick in the source code to avoid such unstabiltiy
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.python.ops</span> <span class="kn">import</span> <span class="n">clip_ops</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">constant_op</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_constant_to_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">constant_op</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">loss_object</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">CategoricalCrossentropy</span><span class="p">(</span>
        <span class="n">from_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">label_smoothing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">epsilon_</span> <span class="o">=</span> <span class="n">_constant_to_tensor</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">epsilon</span><span class="p">(),</span> <span class="n">prob_dists</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span><span class="p">)</span>
        <span class="n">prob_dists</span> <span class="o">=</span> <span class="n">clip_ops</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">prob_dists</span><span class="p">,</span> <span class="n">epsilon_</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon_</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_object</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">compute_average_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">global_batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-Metric-Function">
<a class="anchor" href="#Custom-Metric-Function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Metric Function<a class="anchor-link" href="#Custom-Metric-Function"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_loss'</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_acc'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">acc</span>

<span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="n">train_loss_obj</span><span class="p">,</span> <span class="n">train_acc_obj</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="s1">'train'</span><span class="p">)</span>
    <span class="n">valid_loss_obj</span><span class="p">,</span> <span class="n">valid_acc_obj</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">(</span><span class="s1">'valid'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-Training-Loop">
<a class="anchor" href="#Custom-Training-Loop" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Training Loop<a class="anchor-link" href="#Custom-Training-Loop"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The default runtime in TensorFlow 2.0 is eager execution. As such, our training loop above executes eagerly.
this is great for debugging, but graph compilation has a definite performace advantage. Describing your computation as a static graph enables the framework to apply global performance optimizations. This is impossible when the frameworks is constrained to greedly execute one operation after another, with no knowledge of what comes next.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_input_signature</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">valid_input_signature</span> <span class="o">=</span> <span class="n">train_input_signature</span>
<span class="n">test_input_signature</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">with</span> <span class="n">strategy</span><span class="o">.</span><span class="n">scope</span><span class="p">():</span>
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">input_signature</span><span class="o">=</span><span class="n">train_input_signature</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
            <span class="n">prob_dists</span> <span class="o">=</span> <span class="n">flower_classifier</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">)</span>
            <span class="n">train_acc_obj</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">)</span>

        <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">flower_classifier</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
        <span class="n">grads</span><span class="p">,</span> <span class="n">global_norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_global_norm</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">clip_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">flower_classifier</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>
    
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">distributed_train_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_step</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">input_signature</span><span class="o">=</span><span class="n">valid_input_signature</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">valid_step</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">prob_dists</span> <span class="o">=</span><span class="n">flower_classifier</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">valid_acc_obj</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">prob_dists</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">prob_dists</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">distributed_valid_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">prob_dists</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">valid_step</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="n">labels</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">prob_dists</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">input_signature</span><span class="o">=</span><span class="n">test_input_signature</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="n">prob_dists</span> <span class="o">=</span> <span class="n">flower_classifier</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob_dists</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">distributed_test_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">prob_dists</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test_step</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">images</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">prob_dists</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'train_loss'</span><span class="p">,</span> <span class="s1">'train_acc'</span><span class="p">,</span> <span class="s1">'valid_loss'</span><span class="p">,</span> <span class="s1">'valid_acc'</span><span class="p">,</span>
        <span class="s1">'valid_f1'</span><span class="p">,</span> <span class="s1">'valid_precision'</span><span class="p">,</span> <span class="s1">'valid_recall'</span><span class="p">,</span> <span class="s1">'model_coefs'</span><span class="p">]</span>
<span class="n">history</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TRAIN_NSTEPS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">count_data_items</span><span class="p">(</span><span class="n">train_filenames</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">VALID_NSTEPS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">count_data_items</span><span class="p">(</span><span class="n">valid_filenames</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">TEST_NSTEPS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">count_data_items</span><span class="p">(</span><span class="n">test_filenames</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="p">(</span><span class="n">TRAIN_NSTEPS</span><span class="p">,</span> <span class="n">VALID_NSTEPS</span><span class="p">,</span> <span class="n">TEST_NSTEPS</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">valid_ds</span> <span class="o">=</span> <span class="n">get_valid_dataset</span><span class="p">(</span><span class="n">valid_filenames</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">valid_dist_ds</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">experimental_distribute_dataset</span><span class="p">(</span><span class="n">valid_ds</span><span class="p">)</span>

<span class="n">test_ds</span> <span class="o">=</span> <span class="n">get_test_dataset</span><span class="p">(</span><span class="n">test_filenames</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">im</span><span class="p">,</span><span class="n">lbl</span><span class="p">:</span> <span class="n">im</span><span class="p">)</span>
<span class="n">test_dist_ds</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">experimental_distribute_dataset</span><span class="p">(</span><span class="n">test_ds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm_trues</span> <span class="o">=</span> <span class="p">(</span><span class="n">valid_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">im</span><span class="p">,</span><span class="n">lbl</span><span class="p">:</span> <span class="n">lbl</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">unbatch</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">count_data_items</span><span class="p">(</span><span class="n">valid_filenames</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">next</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The return values of <code>strategy.experiment_run</code> are actually <code>PerReplica</code> objects. For <code>valid_step</code> we defined above, the return value is a tuple of 2 <code>PerReplica</code> object. The 2nd element in the return value is <code>prob_dists</code>, and it looks like.</p>
<div class="highlight"><pre><span></span><span class="n">PerReplica</span><span class="p">:{</span>
            <span class="mi">0</span> <span class="o">/</span><span class="n">job</span><span class="p">:</span><span class="n">worker</span><span class="o">/</span><span class="n">replica</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">task</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">device</span><span class="p">:</span><span class="n">TPU</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">),</span>
            <span class="mi">1</span> <span class="o">/</span><span class="n">job</span><span class="p">:</span><span class="n">worker</span><span class="o">/</span><span class="n">replica</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">task</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">device</span><span class="p">:</span><span class="n">TPU</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">),</span>
            <span class="o">...</span>
            <span class="mi">7</span> <span class="o">/</span><span class="n">job</span><span class="p">:</span><span class="n">worker</span><span class="o">/</span><span class="n">replica</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">task</span><span class="p">:</span><span class="mi">0</span><span class="o">/</span><span class="n">device</span><span class="p">:</span><span class="n">TPU</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
        <span class="p">}</span>
</pre></div>
<p>The 1st element in the return value is <code>loss</code>. It's similar to the above, but a scaler, so we have to convert each of them to a single tf.Tensor manually.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">get_train_dataset</span><span class="p">(</span><span class="n">train_filenames</span><span class="p">)</span>
    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">train_dist_ds</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">experimental_distribute_dataset</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span>

    <span class="n">train_loss_obj</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
    <span class="n">train_acc_obj</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
    <span class="n">valid_loss_obj</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
    <span class="n">valid_acc_obj</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ibatch</span><span class="p">,</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dist_ds</span><span class="p">):</span>
        <span class="n">per_replica_train_loss</span> <span class="o">=</span> <span class="n">distributed_train_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">per_replica_train_loss</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math_reduce_sum</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
        <span class="n">train_loss_obj</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>

    <span class="c1"># print epoch training results</span>
    <span class="c1"># store the epoch training result</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss_obj</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">'train_acc'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc_obj</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

    <span class="n">all_valid_preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ibatch</span><span class="p">,</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_dist_ds</span><span class="p">):</span>
        <span class="n">per_replica_valid_loss</span><span class="p">,</span> <span class="n">per_replica_valid_preds</span> <span class="o">=</span> <span class="n">distributed_valid_step</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">valid_preds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">per_replica_valid_preds</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_preds</span> <span class="o">=</span> <span class="n">valid_preds</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">all_valid_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_preds</span><span class="p">)</span>

        <span class="n">valid_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">per_replica_valid_loss</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">)</span>
        <span class="n">valid_loss_obj</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">)</span>

    <span class="n">history</span><span class="p">[</span><span class="s1">'valid_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_loss_obj</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">'valid_acc'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_acc_obj</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
    <span class="n">all_valid_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_valid_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">cm_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">all_valid_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">cm_trues</span><span class="p">,</span> <span class="n">cm_preds</span><span class="p">,</span>
                  <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">NCLASSES</span><span class="p">),</span> <span class="n">average</span><span class="o">=</span><span class="s1">'macro'</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">cm_trues</span><span class="p">,</span> <span class="n">cm_preds</span><span class="p">,</span>
                  <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">NCLASSES</span><span class="p">),</span> <span class="n">average</span><span class="o">=</span><span class="s1">'macro'</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">cm_trues</span><span class="p">,</span> <span class="n">cm_preds</span><span class="p">,</span>
                  <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">NCLASSES</span><span class="p">),</span> <span class="n">average</span><span class="o">=</span><span class="s1">'macro'</span><span class="p">)</span>    

    <span class="n">history</span><span class="p">[</span><span class="s1">'valid_f1'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>        
    <span class="n">history</span><span class="p">[</span><span class="s1">'valid_precision'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">'valid_recall'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">'model_coefs'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flower_classifier</span><span class="o">.</span><span class="n">prob_dist_weight</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/blog/plant/classification/tpu/custom/2021/01/26/customize_everything_with_tpu.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Thoughts when I am building</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/austinyhc" title="austinyhc"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/austinyht" title="austinyht"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
